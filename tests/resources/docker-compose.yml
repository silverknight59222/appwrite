version: '3'

services:
  appwrite:
    build: ../../
    restart: unless-stopped
    volumes:
    - appwrite-uploads:/storage/uploads:rw
    - appwrite-cache:/storage/cache:rw
    - ./../../app:/usr/share/nginx/html/app
    - ./../../public:/usr/share/nginx/html/public
    - ./../../src:/usr/share/nginx/html/src
    - ./../../vendor:/usr/share/nginx/html/vendor
    - ./../../docker/nginx.conf:/etc/nginx/nginx.conf:rw
    ports:
    - "80:80"
    - "443:443"
    depends_on:
    - mariadb
    - redis
    - smtp
    - clamav
    - influxdb
    - telegraf
    environment:
    - _APP_ENV=development
    - _APP_OPTIONS_ABUSE=disabled
    - _APP_OPENSSL_KEY_V1=just-a-random-key
    - _APP_REDIS_HOST=redis
    - _APP_REDIS_PORT=6379
    - _APP_DB_HOST=mariadb
    - _APP_DB_PORT=3306
    - _APP_DB_SCHEMA=appwrite
    - _APP_DB_USER=user
    - _APP_DB_PASS=password
    - _APP_INFLUXDB_HOST=influxdb
    - _APP_INFLUXDB_PORT=8086
    - _APP_STATSD_HOST=telegraf
    - _APP_STATSD_PORT=8125

  mariadb:
    image: appwrite/mariadb:1.0.0
    restart: unless-stopped
    environment:
    - MYSQL_ROOT_PASSWORD=rootsecretpassword
    - MYSQL_DATABASE=appwrite
    - MYSQL_USER=user
    - MYSQL_PASSWORD=password
    ports:
    - 3306:3306/tcp
    #command: mysqld --innodb-flush-method=fsync

  smtp:
    image: appwrite/smtp:1.0.0
    environment:
    - MAILNAME=appwrite
    - RELAY_NETWORKS=:192.168.0.0/24:10.0.0.0/16
    ports:
    - "25:25"

  clamav:
    image: appwrite/clamav:1.0.4
    restart: unless-stopped
    volumes:
    - appwrite-uploads:/storage/uploads
      
  redis:
    image: redis:5.0
    restart: unless-stopped

  influxdb:
    image: influxdb:1.6
    volumes:
    - appwrite-influxdb:/var/lib/influxdb:rw
    ports:
    - "8086:8086"

  telegraf:
    image: appwrite/telegraf:1.0.0
    ports:
    - "8125:8125/udp"

volumes:
  appwrite-db:
  appwrite-cache:
  appwrite-uploads:
  appwrite-influxdb: